# 12個月回填後IC/PMR評估報告

**報告時間**: 2025-11-16 20:40 UTC+8
**評估目標**: 使用回填數據重跑短窗IC/PMR評估 (H=1/2/3, lag=1h)，確認是否首次達成Hard門檻

---

## 執行摘要

**結論**: ❌ **無法進行有效IC/PMR評估 - Hard門檻未達成**

**根本原因**: 數據碎片化問題導致無法形成連續90天窗口

---

## 數據回填狀況

### 月度檔案檢查 (data/gdelt_hourly_monthly/)

發現13個月度檔案 (2024-10 至 2025-10):

| 月份 | 總行數 | Bucket數據覆蓋率 | mapped_ratio |
|------|--------|------------------|--------------|
| 2024-10 | 60 | ✅ 100% | 0.889 |
| 2024-11 | 720 | ✅ 100% | 0.860 |
| 2024-12 | 744 | ✅ 100% | 0.826 |
| 2025-01 | 605 | ✅ 100% | 0.821 |
| 2025-02 | 672 | ✅ 100% | 0.856 |
| **2025-03** | 744 | ❌ **0%** | N/A |
| **2025-04** | 720 | ❌ **0%** | N/A |
| **2025-05** | 744 | ❌ **0%** | N/A |
| **2025-06** | 329 | ❌ **0%** | N/A |
| **2025-07** | 718 | ❌ **0%** | N/A |
| **2025-08** | 744 | ❌ **0%** | N/A |
| **2025-09** | 720 | ❌ **0%** | N/A |
| 2025-10 | 681 | ✅ 100% | 0.578 |

**關鍵發現**:
- ✅ **6個月有完整bucket數據** (2024-10~2025-02, 2025-10)
- ❌ **7個月完全缺失bucket數據** (2025-03~2025-09)
- 總計: 3,482行有bucket數據 (42.5%)

### 重建gdelt_hourly.parquet結果

```
總行數: 8,201
有bucket數據: 3,482行 (42.5%)
時間範圍: 2024-10-29 12:00 UTC ~ 2025-10-29 09:00 UTC

Bucket特徵覆蓋率:
- OIL_CORE_norm_art_cnt: 3,482 (42.5%)
- GEOPOL_norm_art_cnt: 3,482 (42.5%)
- USD_RATE_norm_art_cnt: 3,482 (42.5%)
- SUPPLY_CHAIN_norm_art_cnt: 3,482 (42.5%)
- MACRO_norm_art_cnt: 3,482 (42.5%)
```

---

## 價格數據與GDELT重疊分析

### features_hourly.parquet狀況

```
總行數: 8,757
時間範圍: 2024-10-29 13:00 UTC ~ 2025-10-29 09:00 UTC
非零ret_1h: 5,986行 (68.4%)
```

### 重疊數據統計

```
GDELT與價格重疊: 8,200行
同時有bucket+價格: 3,481行
其中非零ret_1h: 2,372行 (68.1%)
```

**表面看起來**:
2,372行有效數據 ≈ 99天,應該足夠進行90天窗口評估

**實際情況**:
數據嚴重碎片化!

---

## 數據連續性診斷

### 最長連續段分析

```
時間跨度: 2024-10-29 13:00 ~ 2025-01-12 15:00 (75.1天)
總行數: 1,803小時

ret_1h分布:
- 非null: 575/1803 (31.9%)  ← 市場非24小時交易
- 零值: 575/1803 (31.9%)
- 非零: 1,228/1803 (68.1%)
```

### 週末Gap問題

**每週都有48-72小時的gap** (週五晚~週一早):

```
大於48小時的gap: 22個

典型週末gap:
- 2024-11-03 23:00: gap = 2天2小時
- 2024-11-10 23:00: gap = 2天2小時
- 2024-11-17 23:00: gap = 2天2小時
- ... (每週重複)
```

### 有效數據段分析

經過lag=1h和forward_return過濾後:

```
總有效行: 521 (從1,803中)
相鄰連續率: 98.1%
BUT被分割成: 11個獨立段

每段長度: 全部為48小時 (2天) = 工作日交易時間
```

**最長有效段僅2天 << 需要的90天窗口!**

---

## IC/PMR評估嘗試結果

### 評估參數

```python
H_LIST = [1, 2, 3]  # 小時
LAG = 1  # 小時
TRAIN_DAYS = 60
TEST_DAYS = 30
RIDGE_L2 = 1.0

Hard閾值:
- IC >= 0.02
- IR >= 0.5
- PMR >= 0.55
```

### 評估結果

#### H=1, 2, 3 全部失敗:

```
H=1: 有效數據僅521行,調整窗口為train=312h/test=156h
     → [SKIP] 無法形成有效窗口 (數據太碎片化)

H=2: 有效數據510行
     → [SKIP] 無法形成有效窗口

H=3: 有效數據499行 (< 500小時閾值)
     → [SKIP] 數據不足
```

**IC計算結果: 全部為NaN或無法計算**

---

## 根本問題總結

### 1. 數據覆蓋Gap (嚴重)

**2025-03 至 2025-09 (7個月) 完全缺失bucket數據**

這造成:
- 無法形成連續的12個月數據
- 最長連續段被限制在2024-10~2025-01 (約3個月)

**可能原因**:
- GDELT數據收集中斷?
- Bucket聚合腳本未在這段期間運行?
- 數據存儲/傳輸問題?

**需要行動**: 調查2025-03~2025-09期間的raw GDELT數據是否存在,如存在需重新聚合

### 2. 交易時間碎片化 (本質問題)

**問題**: ret_1h只在市場交易時間非null

這導致:
- 每天只有部分小時有數據 (~8-10小時?)
- 週末完全無數據 (48-72小時gap)
- 連續段被切割成2天工作日片段

**影響**:
- 即使有連續的calendar時間,有效數據仍極度分散
- 無法滿足IC評估的連續窗口需求 (90天 = 2,160小時)
- 目前最長有效段僅48小時 << 2,160小時

### 3. IC評估方法論不適配 (設計問題)

**當前方法假設**:
- 連續hourly數據 (24/7)
- 固定H小時forward return
- 60天訓練 + 30天測試的滾動窗口

**實際數據特性**:
- 非連續 (工作日交易時間only)
- 週末gap
- 跨月gap (2025-03~09)

**不匹配!**

---

## 下一步行動建議

### 短期 (1-2週)

#### 優先級1: 調查並修復2025-03~09數據缺失
```
1. 檢查是否有這7個月的raw GDELT GKG數據
2. 如有,重新運行gdelt_gkg_bucket_aggregator.py聚合
3. 更新月度parquet文件
4. 重新rebuild gdelt_hourly.parquet
```

#### 優先級2: 重新設計IC評估方法論
```
選項A: 僅使用交易時間
- 修改forward return計算: 使用"下N個交易小時"而非"N小時後"
- 調整窗口計算: 使用"交易日"而非"calendar日"
- 例: 60交易日 ≈ 12週 ≈ 3個月

選項B: 填充非交易時間
- 對ret_1h在非交易時間填0 (已知市場未開)
- 保持hourly連續性
- IC計算時加權或mask非交易時間

選項C: 降低窗口需求 (不推薦 - 違反方法論)
- 減少TRAIN_DAYS/TEST_DAYS
- 但會降低統計顯著性
```

### 中期 (1-3月)

#### 如數據完整性修復成功:

1. **重新回填missing 7個月**
   - 獲取2025-03~09的GKG raw data
   - 運行聚合生成bucket features
   - 目標: 12個月連續bucket數據

2. **實現交易時間aware IC評估**
   - 新腳本: `evaluate_ic_trading_hours.py`
   - 使用`is_trading_hour`標記
   - 計算"交易日"窗口

3. **重跑評估**
   - 使用修復後的12個月數據
   - 新的evaluation methodology
   - 預期: 可能達成Hard IC閾值

### 長期 (3-6月)

#### 如數據無法完整修復:

**接受現實,調整策略**:

1. **等待新數據積累**
   - 從2025-10起確保每月bucket數據完整收集
   - 等待3-6個月形成連續dataset
   - 2026-Q1重新評估

2. **使用現有最佳數據段**
   - 2024-10~2025-02 (5個月,部分連續)
   - 實施reduced-window評估
   - 作為Shadow/Experimental結果 (非正式Hard候選)

3. **考慮方法論調整**
   - 評估是否可放寬連續性要求
   - 使用"可用交易日"而非"calendar日"
   - 需與stakeholder討論並記錄於No-Drift合約

---

## 技術細節與文件

### 生成的關鍵文件

```
data/gdelt_hourly.parquet (重建完成)
  - 8,201行, 60欄位
  - 3,482行有bucket數據 (42.5%)

診斷腳本:
  - inspect_monthly_correct.py
  - diagnose_data_gap.py
  - diagnose_longest_segment.py
  - check_price_data.py

評估腳本 (未成功):
  - evaluate_composite_ic.py
  - evaluate_composite_ic_v2.py

本報告:
  - warehouse/analysis/backfill_evaluation_report_20251116.md
```

### 數據質量指標

| 指標 | 目標 | 實際 | 達成 |
|------|------|------|------|
| 月度bucket覆蓋 | 12/12月 | 6/13月 | ❌ 46% |
| 連續窗口長度 | 90天 | 2天 | ❌ 2.2% |
| 有效數據量 | 2,160h | 48h | ❌ 2.2% |
| IC評估可行性 | Yes | No | ❌ |
| Hard IC達標 | ≥1組 | 0組 | ❌ |

---

## 結論

**12個月回填已完成,但無法達成Hard IC評估目標**

主要障礙:
1. ❌ 7個月bucket數據缺失 (2025-03~09)
2. ❌ 交易時間碎片化導致無法形成連續窗口
3. ❌ IC評估方法論與實際數據特性不匹配

**下一步**: 必須先修復數據gap並調整評估方法論,才能有希望達成Hard IC閾值

**狀態**:
- ✅ 數據回填技術可行
- ✅ 重建pipeline正常
- ❌ 數據完整性不足
- ❌ IC評估無法執行
- ❌ Hard門檻未達成

---

**報告生成**: 2025-11-16 20:40 UTC+8
**執行者**: Claude Code (自動診斷pipeline)
